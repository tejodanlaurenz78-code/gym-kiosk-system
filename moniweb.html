<!DOCTYPE html>
<html lang="en">
<head>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, child, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyArmkpNiknD7u5vJBd1XFOWm0DjkaZHieQ",
            authDomain: "group4-ee960.firebaseapp.com",
            databaseURL: "https://group4-ee960-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "group4-ee960",
            storageBucket: "group4-ee960.firebasestorage.app",
            messagingSenderId: "453765398844",
            appId: "1:453765398844:web:219433f771cfd33b311e39",
            measurementId: "G-41DZ3175NX"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.db = db;
        window.ref = ref;
        window.get = get;
        window.child = child;
        window.onValue = onValue;
        
        console.log("‚úÖ Firebase initialized successfully!");
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PnC Request Monitoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e8e8e8;
        }

        /* Header */
        .header-green {
            background-color: #15803d;
        }

        /* Cards */
        .card-white {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .card-yellow-border {
            border-top: 4px solid #f59e0b;
        }

        /* Alert box */
        .alert-warning {
            background-color: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
        }

        /* Timeline - Updated for cleaner design */
        .timeline-dot {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Search input with QR icon */
        .input-with-icon {
            position: relative;
        }

        .qr-icon {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        /* Buttons */
        .btn-primary {
            background-color: #15803d;
            color: white;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #166534;
        }

        .btn-secondary {
            background-color: white;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
        }

        /* Form styles - 100% identical to k.txt and ad27.txt */
        .form-container {
            background: white;
            border: 1px solid #000;
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }

        .form-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .form-title {
            background-color: #D1D5DB;
            font-weight: bold;
            text-align: center;
            padding: 0.5rem;
            text-transform: uppercase;
            font-size: 1.1rem;
            margin-bottom: 0;
            border: none;
            color: black;
        }

        .read-only-field {
            border-bottom: 1px solid black;
            width: 100%;
            padding-left: 0.25rem;
            font-weight: bold;
            min-height: 24px;
            display: inline-block;
        }

        .border-black {
            border-color: black;
        }

        .accent-black {
            accent-color: black;
        }

        .line-input {
            border-bottom: 1px solid #000;
            width: 100%;
            outline: none;
            background: transparent;
            padding-left: 0.25rem;
        }

        /* Status badge */
        .badge-appointment {
            background-color: #fef3c7;
            color: #92400e;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
    </style>
</head>

<body class="min-h-screen">

    <!-- Header -->
    <header class="header-green shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="pnc-logo.jpg" alt="PnC Logo" class="w-16 h-16 rounded-full border-2 border-white/50 shadow-lg">
                <div>
                    <h1 class="text-white text-lg font-bold">Request Monitoring</h1>
                    <p class="text-green-100 text-xs">University of Cabuyao</p>
                </div>
            </div>
            <button onclick="showSearch()" class="text-white font-semibold hover:text-green-100 transition flex items-center space-x-2">
                <span>‚Üê</span>
                <span>Track Another</span>
            </button>
        </div>
    </header>

    <!-- Search View -->
    <div id="searchView" class="max-w-2xl mx-auto px-6 py-16">
        <div class="card-white p-12">
            <div class="text-center mb-8">
                <div class="w-20 h-20 mx-auto bg-green-50 rounded-2xl flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold text-gray-900 mb-3">Track Your Request</h2>
                <p class="text-gray-600">Enter the Transaction ID from your receipt or scan the QR Code.</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Transaction ID</label>
                    <div class="input-with-icon">
                        <input 
                            type="text" 
                            id="trackInput" 
                            placeholder="RES-XXXXXX"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-200 outline-none transition"
                        >
                        <div class="qr-icon">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <button onclick="trackRequest()" class="btn-primary w-full">
                    Track Status
                </button>

                <div id="errorMsg" class="hidden mt-4 p-4 bg-red-50 border-l-4 border-red-500 rounded-lg">
                    <p class="text-red-700 font-semibold">‚ùå Request not found. Please check your Transaction ID.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Results View -->
    <div id="resultsView" class="hidden max-w-7xl mx-auto px-6 py-8 pb-20">
        <!-- Status Alert Banner -->
        <div id="statusAlert" class="hidden mb-6 p-4 rounded-lg border-l-4"></div>
        
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <!-- Left Card - Request Details -->
            <div class="lg:col-span-2">
                <div class="card-white p-6">
                    <div id="requestDetailsCard"></div>
                </div>
            </div>
            
            <!-- Right Card - Approval Timeline -->
            <div class="lg:col-span-3">
                <div class="card-white p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-900 flex items-center">
                            <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            Approval Timeline
                        </h3>
                        <span class="text-xs text-gray-500" id="lastUpdated">Last updated: Just now</span>
                    </div>
                    <div id="timelineContent"></div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-6 flex justify-center space-x-4">
            <button onclick="switchTab('form2')" class="btn-secondary flex items-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span>View Submission Documents</span>
            </button>
        </div>

        <!-- Forms Modal -->
        <div id="formsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-6">
            <div class="bg-white rounded-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto">
                <div class="sticky top-0 bg-white border-b px-6 py-4 flex items-center justify-between">
                    <h3 class="text-xl font-bold">Submission Documents</h3>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div class="p-6">
                    <div id="form2Content" class="mb-8"></div>
                    <div id="form1Content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentRequest = null;

        function showSearch() {
            // Clear URL parameters
            if (window.history.replaceState) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            document.getElementById('searchView').classList.remove('hidden');
            document.getElementById('resultsView').classList.add('hidden');
            document.getElementById('trackInput').value = '';
            document.getElementById('errorMsg').classList.add('hidden');
        }

        function switchTab(tab) {
            document.getElementById('formsModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('formsModal').classList.add('hidden');
        }

        function cancelRequest() {
            if (confirm('Are you sure you want to cancel this request?')) {
                alert('Request cancellation submitted.');
            }
        }

        function trackRequest() {
            const trackId = document.getElementById('trackInput').value.trim();

            if (!trackId) {
                alert('Please enter a Transaction ID');
                return;
            }

            const requestRef = window.ref(window.db, `requests/${trackId}`);

            // Use onValue for real-time updates
            window.onValue(requestRef, (snapshot) => {
                if (snapshot.exists()) {
                    currentRequest = snapshot.val();
                    displayRequest(currentRequest);
                    document.getElementById('searchView').classList.add('hidden');
                    document.getElementById('resultsView').classList.remove('hidden');
                    document.getElementById('errorMsg').classList.add('hidden');
                    
                    // Update "Last updated" timestamp
                    const now = new Date().toLocaleString('en-US', { 
                        hour: 'numeric', 
                        minute: 'numeric', 
                        hour12: true 
                    });
                    document.getElementById('lastUpdated').textContent = `Last updated: ${now}`;
                } else {
                    document.getElementById('errorMsg').classList.remove('hidden');
                }
            }, (error) => {
                console.error('Error:', error);
                alert('Error loading request. Please try again.');
            });
        }


        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function showStatusAlert(request) {
            const alertDiv = document.getElementById('statusAlert');
            const status = request.status || '';
            
            if (status.includes('Rejected')) {
                alertDiv.className = 'mb-6 p-4 rounded-lg border-l-4 bg-red-50 border-red-500';
                alertDiv.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <h4 class="font-bold text-red-900">Request Rejected</h4>
                            <p class="text-sm text-red-700 mt-1">Your request has been rejected. Please check the timeline below for details.</p>
                        </div>
                    </div>
                `;
                alertDiv.classList.remove('hidden');
            } else if (status.includes('Appointment')) {
                alertDiv.className = 'mb-6 p-4 rounded-lg border-l-4 bg-yellow-50 border-yellow-500';
                alertDiv.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-yellow-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <h4 class="font-bold text-yellow-900">üìÖ Appointment Required</h4>
                            <p class="text-sm text-yellow-700 mt-1">An appointment has been set. Please check the timeline below for appointment details.</p>
                        </div>
                    </div>
                `;
                alertDiv.classList.remove('hidden');
            } else if (status.includes('Approved') || status.includes('Completed')) {
                alertDiv.className = 'mb-6 p-4 rounded-lg border-l-4 bg-green-50 border-green-500';
                alertDiv.innerHTML = `
                    <div class="flex items-start">
                        <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <div>
                            <h4 class="font-bold text-green-900">‚úÖ Request Approved</h4>
                            <p class="text-sm text-green-700 mt-1">Your request has been approved. You can now proceed to document stamping.</p>
                        </div>
                    </div>
                `;
                alertDiv.classList.remove('hidden');
            } else {
                alertDiv.classList.add('hidden');
            }
        }

        function getStatusBadge(status) {
            if (!status) status = 'Processing';
            
            let bgClass = 'bg-blue-100 border-blue-300';
            let textClass = 'text-blue-700';
            
            if (status.includes('Rejected')) {
                bgClass = 'bg-red-100 border-red-300';
                textClass = 'text-red-700';
            } else if (status.includes('Appointment')) {
                bgClass = 'bg-yellow-100 border-yellow-300';
                textClass = 'text-yellow-700';
            } else if (status.includes('Approved') || status.includes('Completed')) {
                bgClass = 'bg-green-100 border-green-300';
                textClass = 'text-green-700';
            } else if (status.includes('Pending')) {
                bgClass = 'bg-blue-100 border-blue-300';
                textClass = 'text-blue-700';
            }
            
            return `<div class="inline-block px-4 py-2 rounded-full ${bgClass} border-2">
                        <p class="text-sm font-bold ${textClass} uppercase">${status}</p>
                    </div>`;
        }

                function displayRequest(request) {
            // Show status alerts
            showStatusAlert(request);
            
            // Request Details Card (Left)
            const venueList = Array.isArray(request.venue) ? request.venue.join(', ') : request.venue || 'Not specified';
            
            document.getElementById('requestDetailsCard').innerHTML = `
                <div class="space-y-6">
                    <div>
                        <p class="text-sm font-semibold text-gray-500 mb-2">TRANSACTION ID</p>
                        <p class="text-2xl font-bold text-gray-900">${request.id || 'N/A'}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm font-semibold text-gray-500 mb-2">EVENT TITLE</p>
                        <p class="text-lg font-semibold text-green-700">${request.activityName || 'Untitled Event'}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm font-semibold text-gray-500 mb-2">REQUESTED DATE</p>
                        <p class="text-gray-700">${formatDate(request.activityDate) || 'Not specified'}</p>
                    </div>
                    
                    <div>
                        <p class="text-sm font-semibold text-gray-500 mb-2">VENUE</p>
                        <p class="text-gray-700">${venueList}</p>
                    </div>
                    
                    <div class="pt-4 border-t">
                        <p class="text-xs text-gray-500 mb-2">Overall Status</p>
                        ${getStatusBadge(request.status)}
                    </div>
                </div>
            `;

            // Timeline
            document.getElementById('timelineContent').innerHTML = renderTimeline(request);

            // Forms
            document.getElementById('form2Content').innerHTML = renderForm2Content(request);
            document.getElementById('form1Content').innerHTML = renderForm1Content(request);
        }
        function renderTimeline(request) {
            const steps = [
                {
                    label: 'Request Submitted',
                    sublabel: 'Successfully processed by Applicant.',
                    status: 'Approved',
                    date: request.filingDate || request.timestamp,
                    icon: '‚úì'
                },
                {
                    label: 'Endorsed/Reviewed',
                    sublabel: 'Successfully processed by Department Head.',
                    status: request.approvals?.deptHead?.status || 'Approved',
                    date: request.approvals?.deptHead?.date || '',
                    remarks: request.approvals?.deptHead?.remarks || '',
                    icon: '‚úì'
                },
                {
                    label: 'Recommended',
                    sublabel: 'Currently with the PM Officer for action.',
                    status: request.approvals?.pmOfficer?.status || 'Pending',
                    date: request.approvals?.pmOfficer?.date || '',
                    remarks: request.approvals?.pmOfficer?.remarks || '',
                    icon: request.approvals?.pmOfficer?.status === 'Approved' ? '‚úì' : 
                          request.approvals?.pmOfficer?.status === 'Appointment Set' ? 'üìÖ' :
                          request.approvals?.pmOfficer?.status === 'Rejected' ? '‚úï' : '‚è±'
                },
                {
                    label: 'Final Approval',
                    sublabel: '',
                    status: request.approvals?.pmgsdDirector?.status || 'Pending',
                    date: request.approvals?.pmgsdDirector?.date || '',
                    remarks: request.approvals?.pmgsdDirector?.remarks || '',
                    icon: request.approvals?.pmgsdDirector?.status === 'Approved' ? '‚úì' :
                          request.approvals?.pmgsdDirector?.status === 'Appointment Set' ? 'üìÖ' :
                          request.approvals?.pmgsdDirector?.status === 'Rejected' ? '‚úï' : '‚óã'
                },
                {
                    label: 'Document Stamping',
                    sublabel: '',
                    status: request.stamped ? 'Approved' : 'Pending',
                    date: request.stampedDate || '',
                    icon: request.stamped ? '‚úì' : '‚óã'
                }
            ];

            return steps.map((step, index) => {
                const isCompleted = step.status === 'Approved';
                const isAppointment = step.status === 'Appointment Set';
                const isRejected = step.status === 'Rejected';
                const isInProgress = step.status === 'Pending' && index > 0 && steps[index - 1].status === 'Approved';
                const isPending = step.status === 'Pending' && !isInProgress;
                
                let dotClass = 'bg-gray-200 text-gray-400';
                let textClass = 'text-gray-400';
                let statusText = '';
                let statusDate = '';
                let remarksHTML = '';
                
                if (isCompleted) {
                    dotClass = 'bg-green-600 text-white';
                    textClass = 'text-gray-900';
                    statusText = `<span class="text-xs font-semibold text-green-600">Completed</span>`;
                    statusDate = step.date ? `<span class="text-xs text-gray-500">on ${formatDate(step.date)}</span>` : '';
                } else if (isAppointment) {
                    dotClass = 'bg-yellow-500 text-white';
                    textClass = 'text-gray-900';
                    statusText = `<span class="text-xs font-semibold text-yellow-600">Appointment Set</span>`;
                    statusDate = step.date ? `<span class="text-xs text-gray-500">on ${formatDate(step.date)}</span>` : '';
                    remarksHTML = step.remarks ? `
                        <div class="mt-2 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <p class="text-xs font-semibold text-yellow-900">üìÖ Appointment Details:</p>
                            <p class="text-xs text-yellow-800 mt-1 whitespace-pre-line">${step.remarks}</p>
                        </div>
                    ` : '';
                } else if (isRejected) {
                    dotClass = 'bg-red-600 text-white';
                    textClass = 'text-gray-900';
                    statusText = `<span class="text-xs font-semibold text-red-600">Rejected</span>`;
                    statusDate = step.date ? `<span class="text-xs text-gray-500">on ${formatDate(step.date)}</span>` : '';
                    remarksHTML = step.remarks ? `
                        <div class="mt-2 p-3 bg-red-50 border-l-4 border-red-400 rounded">
                            <p class="text-xs font-semibold text-red-900">‚ùå Rejection Reason:</p>
                            <p class="text-xs text-red-800 mt-1">${step.remarks}</p>
                        </div>
                    ` : '';
                } else if (isInProgress) {
                    dotClass = 'bg-yellow-500 text-white';
                    textClass = 'text-gray-900';
                    statusText = `<span class="text-xs font-semibold text-yellow-600">In Progress</span>`;
                }

                return `
                    <div class="relative flex items-start space-x-4 pb-8 ${index === steps.length - 1 ? 'pb-0' : ''}">
                        ${index < steps.length - 1 ? '<div class="absolute left-5 top-12 w-0.5 h-full bg-gray-200"></div>' : ''}
                        <div class="timeline-dot ${dotClass} w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg flex-shrink-0 z-10">
                            ${step.icon}
                        </div>
                        <div class="flex-1 pt-1">
                            <div class="flex items-start justify-between">
                                <div class="w-full">
                                    <h4 class="font-bold ${textClass} text-base">${step.label}</h4>
                                    <p class="text-sm ${textClass === 'text-gray-900' ? 'text-gray-600' : 'text-gray-400'} mt-1">${step.sublabel}</p>
                                    ${statusText ? `<div class="mt-2 flex items-center space-x-2">${statusText} ${statusDate}</div>` : ''}
                                    ${remarksHTML}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 100% IDENTICAL FORM 2 FROM AD27.TXT
        function renderForm2Content(request) {
            const deptHead = request.approvals?.deptHead || {};
            const pmOfficer = request.approvals?.pmOfficer || {};
            const pmgsdDirector = request.approvals?.pmgsdDirector || {};
            
            const venues = Array.isArray(request.venue) ? request.venue : (request.venue ? Object.values(request.venue) : []);
            const equipments = Array.isArray(request.equipment) ? request.equipment : (request.equipment ? Object.values(request.equipment) : []);
            
            const val = (v) => v || '';
            const isChecked = (list, item) => (list && list.includes(item)) ? 'checked' : '';

            const getEquip = (name, field) => {
                const item = equipments.find(e => e.name === name);
                return item ? item[field] : '';
            };
            const isEquipChecked = (name) => equipments.some(e => e.name === name) ? 'checked' : '';
            const manpower = request.manpower || {};

            function getStatusClass(status) {
                if (status === 'Approved') return 'bg-green-100 text-green-700';
                if (status === 'Rejected') return 'bg-red-100 text-red-700';
                return 'bg-yellow-100 text-yellow-700';
            }

            return `
                <div class="form-header flex items-center justify-center space-x-4 mb-6">
                    <img src="pnc-logo.jpg" alt="PnC Logo" class="w-16 h-16 rounded-full border-2 border-white/50 shadow-lg">
                    <div class="text-center">
                        <p class="text-sm">Republic of the Philippines</p>
                        <h2 class="text-2xl font-bold text-green-800 font-serif">Pamantasan ng Cabuyao</h2>
                        <p class="text-sm font-bold">(UNIVERSITY OF CABUYAO)</p>
                        <p class="text-sm italic">Administration and Finance Division</p>
                        <p class="font-bold text-gray-700 mt-1">Property Management and General Services Department</p>
                        <p class="text-xs text-gray-500">Katapatan Mutual Homes, Brgy. Banay-banay, City of Cabuyao, Laguna 4025</p>
                    </div>
                </div>

                <div class="form-title text-black bg-gray-300">EQUIPMENT AND VENUE RESERVATION AND STATUS REPORT FORM</div>

                <div class="border-b border-black p-4 space-y-4 text-sm text-black">
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1">
                            <label class="font-normal text-gray-600">Transaction Number:</label>
                            <div class="read-only-field">${val(request.id)}</div>
                        </div>
                        <div class="flex-1">
                            <label class="font-normal text-gray-600">Date of Filing:</label>
                            <div class="read-only-field">${formatDate(request.filingDate)}</div>
                        </div>
                        <div class="flex-1">
                            <label class="font-normal text-gray-600">Department:</label>
                            <div class="read-only-field">${val(request.department)}</div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-4">
                        <div class="flex-1">
                            <label class="font-normal text-gray-600">Activity Date:</label>
                            <div class="read-only-field">${formatDate(request.activityDate)}</div>
                        </div>
                        <div class="flex-1">
                            <label class="font-normal text-gray-600">Time:</label>
                            <div class="read-only-field">${val(request.time)}</div>
                        </div>
                    </div>

                    <div>
                        <label class="font-normal text-gray-600">Activity Name/Title/Purpose:</label>
                        <div class="read-only-field">${val(request.activityName)}</div>
                    </div>

                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="w-1/3 font-normal text-gray-600">Expected # of Participants:</div>
                        <div class="flex-1 flex items-center"><span class="mr-2">Internal:</span>
                            <div class="read-only-field w-20 text-center">${val(request.internalParticipants)}</div>
                        </div>
                        <div class="flex-1 flex items-center"><span class="mr-2">External:</span>
                            <div class="read-only-field w-20 text-center">${val(request.externalParticipants)}</div>
                        </div>
                    </div>
                </div>

                <div class="border border-black border-t-0 flex text-black">
                    <div class="w-40 font-bold p-2 bg-gray-50 border-r border-black flex items-center">Venue Reservation</div>
                    <div class="flex-1 p-2 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isChecked(venues, 'Gym Stage / Court')} class="accent-black"> <span>Gym Stage / Court</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isChecked(venues, 'Multi-Purpose Hall')} class="accent-black"> <span>Multi-Purpose Hall</span></label>
                        <div class="flex items-center space-x-2">
                             <input type="checkbox" disabled ${venues.some(v => v.includes('Classroom')) ? 'checked' : ''}> 
                             <span>Classroom #</span> 
                             <div class="read-only-field w-16 text-center">${(venues.find(v => v.includes('Classroom')) || '').replace('Classroom', '').trim()}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                             <input type="checkbox" disabled ${venues.some(v => v.includes('Laboratory')) ? 'checked' : ''}> 
                             <span>Laboratory #</span> 
                             <div class="read-only-field w-16 text-center">${(venues.find(v => v.includes('Laboratory')) || '').replace('Laboratory', '').trim()}</div>
                        </div>
                        <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isChecked(venues, 'Library')} class="accent-black"> <span>Library</span></label>
                        <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isChecked(venues, 'Cafeteria')} class="accent-black"> <span>Cafeteria</span></label>
                        <div class="col-span-2 flex items-center space-x-2">
                            <input type="checkbox" disabled ${venues.some(v => v.includes('Others:')) ? 'checked' : ''}> 
                            <span>Others:</span> 
                            <div class="read-only-field flex-1">${(venues.find(v => v.includes('Others:')) || '').replace('Others:', '').trim()}</div>
                        </div>
                    </div>
                </div>

                <div class="border border-black border-t-0 flex text-black">
                    <div class="w-40 font-bold p-2 bg-gray-50 border-r border-black">
                        <p>Equipment Reservation</p>
                        <p class="mt-4 text-xs font-bold">Set-up Details:</p>
                        <div class="mt-1 text-xs font-normal space-y-1 text-gray-600">
                            <p>Ingress Date: <span class="border-b border-black px-1 min-w-[50px] inline-block font-bold text-black">${val(request.ingressDate)}</span></p>
                            <p>Time: <span class="border-b border-black px-1 min-w-[50px] inline-block font-bold text-black">${val(request.ingressTime)}</span></p>
                            <p class="mt-1">Egress Date: <span class="border-b border-black px-1 min-w-[50px] inline-block font-bold text-black">${val(request.egressDate)}</span></p>
                            <p>Time: <span class="border-b border-black px-1 min-w-[50px] inline-block font-bold text-black">${val(request.egressTime)}</span></p>
                        </div>
                    </div>
                    <div class="flex-1 p-2 text-sm">
                        <div class="grid grid-cols-1 gap-2 mb-2">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" disabled ${getEquip('Chair', 'count') ? 'checked' : ''} class="accent-black"> 
                                <span>Chair #</span> 
                                <div class="read-only-field w-16 text-center font-bold">${getEquip('Chair', 'count')}</div>
                                <span>Type:</span> <div class="read-only-field flex-1 font-bold">${getEquip('Chair', 'type')}</div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" disabled ${getEquip('Table', 'count') ? 'checked' : ''} class="accent-black"> 
                                <span>Table #</span> 
                                <div class="read-only-field w-16 text-center font-bold">${getEquip('Table', 'count')}</div>
                                <span>Type:</span> <div class="read-only-field flex-1 font-bold">${getEquip('Table', 'type')}</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Podium/Rostrum')} class="accent-black"> <span>Podium/Rostrum</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Sound System')} class="accent-black"> <span>Sound System</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Electric fans')} class="accent-black"> <span>Electric fans</span></label>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" disabled ${getEquip('Microphone', 'count') ? 'checked' : ''} class="accent-black"> 
                                <span>Microphone #</span> 
                                <div class="read-only-field w-12 text-center font-bold">${getEquip('Microphone', 'count')}</div>
                            </div>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Extension Cord')} class="accent-black"> <span>Extension Cord</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Panel Board / White Board')} class="accent-black"> <span>Panel/White Board</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Philippine Flag')} class="accent-black"> <span>Philippine Flag</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Pamantasan ng Cabuyao Flag')} class="accent-black"> <span>PnC Flag</span></label>
                            <label class="flex items-center space-x-2"><input type="checkbox" disabled ${isEquipChecked('Multi-media Projector')} class="accent-black"> <span>Projector</span></label>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" disabled ${equipments.some(e => e.name.includes('Others:')) ? 'checked' : ''}> 
                                <span>Others:</span> 
                                <div class="read-only-field w-full font-bold">${(equipments.find(e => e.name.includes('Others:'))?.name || '').replace('Others:', '').trim()}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="border border-black border-t-0 flex text-black">
                    <div class="w-40 font-bold p-2 bg-gray-50 border-r border-black flex items-center">Manpower Requirement</div>
                    <div class="flex-1 p-2 grid grid-cols-2 gap-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" disabled ${manpower.technical ? 'checked' : ''}> 
                            <span>Technical</span> 
                            <div class="read-only-field flex-1 font-bold">${val(manpower.technical)}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" disabled ${manpower.housekeeping ? 'checked' : ''}> 
                            <span>Housekeeping</span> 
                            <div class="read-only-field flex-1 font-bold">${val(manpower.housekeeping)}</div>
                        </div>
                    </div>
                </div>

                <div class="text-xs text-gray-600 mt-2 mb-6 space-y-1 italic p-2">
                    <p>‚Ä¢ Request must be submitted at least a week before the activity.</p>
                    <p>‚Ä¢ For activities extending beyond regular hours, approval from VP Admin/Finance is required.</p>
                    <p>‚Ä¢ In cases of damage/lost equipment, requesting party replaces item or facilitates repair.</p>
                </div>

                <div class="grid grid-cols-4 gap-4 text-center mt-4 text-black text-xs">
                    <div>
                        <p class="font-bold mb-8 text-gray-700">Requested by:</p>
                        <div class="border-b border-black font-bold uppercase text-black pb-1">${request.requestedBy}</div>
                        <p class="mt-1">Signature over Printed Name/Date</p>
                    </div>
                    
                    <div class="opacity-90">
                        <p class="font-bold mb-8 text-gray-700">Reviewed by:</p>
                        <div class="border-b border-black font-bold uppercase text-black pb-1">${deptHead.name || ''}</div>
                        <p class="mt-1">Department/Division Head</p>
                        <div class="text-[10px] font-bold ${getStatusClass(deptHead.status)} rounded-full inline-block px-2 mt-1">${deptHead.status}</div>
                    </div>

                    <div class="opacity-90">
                        <p class="font-bold mb-8 text-gray-700">Recommended by:</p>
                        <div class="border-b border-black font-bold uppercase text-black pb-1">Mr. Colin B. Garcia</div>
                        <p class="mt-1">PM Officer</p>
                        <div class="text-[10px] font-bold ${getStatusClass(pmOfficer.status)} rounded-full inline-block px-2 mt-1">${pmOfficer.status}</div>
                    </div>

                    <div class="opacity-90">
                        <p class="font-bold mb-8 text-gray-700">Approved by:</p>
                        <div class="border-b border-black font-bold uppercase text-black pb-1">Alfredo Glenn H. Bea√±o</div>
                        <p class="mt-1">PMGSD Director</p>
                        <div class="text-[10px] font-bold ${getStatusClass(pmgsdDirector.status)} rounded-full inline-block px-2 mt-1">${pmgsdDirector.status}</div>
                    </div>
                </div>
            `;
        }

        function renderForm1Content(request) {
            const deptHeadApproval = request.approvals?.deptHead || {};
            const ovpasApproval = request.approvals?.ovpas || {name: '---', status: 'Pending'};
            const oevpApproval = request.approvals?.oevp || {name: '---', status: 'Pending'};
            const oupApproval = request.approvals?.oup || {name: '---', status: 'Pending'};
            
            const logoUrl = 'https://upload.wikimedia.org/wikipedia/en/thumb/c/c8/Pamantasan_ng_Cabuyao_Logo.png/220px-Pamantasan_ng_Cabuyao_Logo.png';
            const purpose = request.form1 ? request.form1.purpose : 'to conduct the activity';
            const venues = Array.isArray(request.venue) ? request.venue : [];

            // FIX: Support both key names ‚Äî kiosk saves as 'globalScannedDocumentUrl',
            //      older records may use 'scannedDocumentUrl'.
            const scannedUrl = request.globalScannedDocumentUrl || request.scannedDocumentUrl || null;

            let documentViewHtml = '';
            if (scannedUrl) {
                documentViewHtml = `
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-base font-bold text-gray-700 flex items-center gap-2">
                                <span class="inline-block w-3 h-3 rounded-full bg-green-500"></span>
                                Your Scanned Request Letter
                            </h4>
                            <a href="${scannedUrl}" target="_blank"
                               class="text-xs text-blue-600 underline hover:text-blue-800">
                                Open full size ‚Üó
                            </a>
                        </div>
                        <div class="border-2 border-gray-200 rounded-lg overflow-hidden shadow-lg bg-gray-50 flex items-center justify-center" style="min-height:400px;">
                            <img src="${scannedUrl}" 
                                 alt="Scanned Request Letter" 
                                 class="max-w-full h-auto object-contain"
                                 style="max-height:900px;"
                                 onerror="this.parentElement.innerHTML='<p class=\\'text-red-500 text-sm p-4\\'>‚ö†Ô∏è Image could not be loaded.<br><a href=\\'${scannedUrl}\\' target=\\'_blank\\' class=\\'underline text-blue-600\\'>Try opening directly</a></p>'">
                        </div>
                    </div>
                `;
            } else {
                // Fallback to text mock-up if no scan exists
                documentViewHtml = `
                    <div class="mb-4 p-3 bg-yellow-50 border border-yellow-300 rounded text-xs text-yellow-800">
                        ‚ö†Ô∏è No scanned document was attached to this request.
                    </div>
                    <div class="relative mb-10">
                         <img src="${logoUrl}" alt="PnC Logo" class="w-24 h-24 object-contain absolute left-0">
                        <div class="text-center relative z-10">
                            <p class="text-xs font-serif text-gray-700">Republic of the Philippines</p>
                            <h1 class="text-5xl tracking-wide my-1 text-[#005728]" style="font-family: 'UnifrakturMaguntia', cursive;">University of Cabuyao</h1>
                            <p class="text-sm font-bold tracking-widest text-gray-700 uppercase font-serif">(PAMANTASAN NG CABUYAO)</p>
                            <p class="text-sm italic text-gray-700 mt-1 font-serif">Property Management and General Service Department</p>
                            <p class="text-[10px] text-gray-500 mt-0.5 font-serif">Katapatan Mutual Homes, Brgy. Banay-banay, City of Cabuyao, Laguna 4025</p>
                        </div>
                    </div>
                    <div class="mb-8"><p class="text-xs text-gray-500">(${request.id})</p><p class="mt-2 text-sm">${formatDate(request.filingDate)}</p></div>
                    <div class="mb-6"><p class="font-bold text-sm">Dr. Roberto F. Ra√±ola Jr.</p><p class="text-sm">OIC-University President</p></div>
                    <div class="mb-8 pl-8"><p class="text-sm"><span class="font-bold">Thru: Mr. Colin B. Garcia</span></p><p class="text-sm ml-9">Vice President for Administration and Linkages</p></div>
                    <div class="text-sm text-justify space-y-4">
                        <p class="indent-8">I am writing to respectfully request your approval for the activity titled "<span class="font-bold uppercase">${request.activityName}</span>". The purpose is ${purpose.toLowerCase()}.</p>
                        <p class="indent-8">We would like to reserve <span class="font-bold">${venues.join(' and ')}</span> on <span class="font-bold">${formatDate(request.activityDate)}</span>.</p>
                        <p class="indent-8">Thank you very much for your favorable response.</p>
                    </div>
                    <div class="mt-8"><p class="text-sm mb-4">Respectfully yours,</p><div class="mt-4"><p class="font-bold uppercase">${request.requestedBy}</p><p class="text-sm text-gray-600">Requester / ${request.department}</p></div></div>
                `;
            }

            return `
                <div class="bg-white p-8 text-gray-900 font-sans leading-relaxed">
                    ${documentViewHtml}
                </div>
            `;
        }

        // AUTO-LOAD FROM QR CODE - Wait for Firebase to be ready
        function autoLoadFromQR() {
            console.log('üîç Checking for QR code parameter...');
            
            // Get URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const idFromUrl = urlParams.get('id');
            
            if (idFromUrl) {
                console.log('‚úÖ QR Code detected! Transaction ID:', idFromUrl);
                
                // Check if Firebase is ready
                if (window.db && window.ref && window.onValue) {
                    console.log('‚úÖ Firebase ready, loading request...');
                    document.getElementById('trackInput').value = idFromUrl;
                    
                    // Give a small delay for DOM to be fully ready
                    setTimeout(() => {
                        trackRequest();
                    }, 500);
                } else {
                    console.log('‚è≥ Firebase not ready yet, waiting...');
                    setTimeout(autoLoadFromQR, 200);
                }
            } else {
                console.log('‚ÑπÔ∏è No QR code parameter found in URL');
            }
        }
        
        // Start checking when page loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', autoLoadFromQR);
        } else {
            // Document already loaded
            autoLoadFromQR();
        }

        window.debugFirebase = function() {
            const requestsRef = window.ref(window.db, 'requests');
            window.get(requestsRef).then((snapshot) => {
                console.log('Firebase data:', snapshot.val());
            });
        };
    </script>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
